---
- name: Create kind cluster
  ansible.builtin.import_playbook: sthings.container.kind
  vars:
    target_host: localhost
    cluster_name: dev
    kind_cluster_name: dev

- name: Deploy AWX
  ansible.builtin.import_playbook: sthings.awx.deploy
  vars:
    target_host: localhost
    cluster_name: dev
    control_plane_ip: "{{ control_plane_ip }}"

- name: Wait for all AWX components to be ready
  ansible.builtin.import_playbook: sthings.awx.check_deployment
  vars:
    target_host: localhost
    cluster_name: dev
    path_to_kubeconfig: /home/sthings/.kube/dev

- name: Add AWX config to molecule host
  hosts: localhost
  become: yes
  tasks:
    - name: Add AWX dev host entry with comment
      ansible.builtin.blockinfile:
        path: /etc/hosts
        marker: "# {mark} ANSIBLE MANAGED BLOCK - AWX Host Entry"
        block: |
          # AWX dev hostname for local testing
          127.0.1.1 {{ awx_host }}

    - name: Write AWX controller config to file
      copy:
        dest: /tmp/awx_controller_config.yaml
        content: |
          controller_host: https://{{ awx_host }}
          controller_username: sthings
        mode: '0600'


  # post_tasks:
  #   - name: Check if awx environment variables are set
  #     ansible.builtin.set_fact:
  #       missing_vars: "{{ missing_vars | default([]) + [item] }}"
  #     when: lookup('env', item, default='') | length == 0
  #     loop:
  #       - CONTROLLER_HOST
  #       - CONTROLLER_USERNAME
  #       - CONTROLLER_PASSWORD
  #       - CONTROLLER_VERIFY_SSL
  #       - VAULT_ROLE_ID
  #       - VAULT_SECRET_ID
  #       - VAULT_ADDR

  #   - name: Fail if required environment variables are missing
  #     ansible.builtin.fail:
  #       msg: "Missing required environment variables: {{ missing_vars | join(', ') }}"
  #     when: missing_vars is defined and missing_vars | length > 0
