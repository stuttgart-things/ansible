---
playbooks:
  - name: deploy_to_k8s
    play: |
      ---
      - hosts: "{{ target_host | default('localhost') }}"
        become: true
        vars:
          tmp_dir: "{{ '~' if ansible_user_id == 'nonroot' else '/tmp' }}"
          local_user: "{{ ansible_user }}"
          become_local_user: true

        vars_files:
          - "{{ path | default('.') }}/{{ profile }}.yaml"
          #- "{{ deployment_vars }}"

        tasks:
          - name: Create pre manifests
            ansible.builtin.include_tasks: manifests.yaml
            loop: "{{ q('ansible.builtin.dict', pre_manifests) }}"
            when: pre_manifests is defined

          - name: Configure and (un)install helm charts
            block:
              - name: Install helm requirements
                ansible.builtin.include_tasks: helm_config.yaml

              - name: Deploy helm chart(s)
                ansible.builtin.include_tasks: helm.yaml
                loop: "{{ q('ansible.builtin.dict', helm_releases) }}"
            when: helm_releases is defined

          - name: Create post manifests
            ansible.builtin.include_tasks: manifests.yaml
            loop: "{{ q('ansible.builtin.dict', post_manifests) }}"
            when: post_manifests is defined

  - name: helm_config
    play: |
      ---
      - name: Add helm chart repositories
        kubernetes.core.helm_repository:
          name: "{{ item.key }}"
          repo_url: "{{ item.value.url }}"
          force_update: true
        loop: "{{ q('ansible.builtin.dict', helm_repositories) }}"
        when: helm_repositories is defined and state == "present"

      - name: Install Helm Diff
        kubernetes.core.helm_plugin:
          plugin_path: "https://github.com/databus23/helm-diff"
          state: present
        when: state == "present"

  - name: helm
    play: |
      ---
      - name: Create helm values on disk
        ansible.builtin.copy:
          content: "{{ item.value.release_values }}" #().0
          dest: "{{ tmp_dir }}/{{ item.key }}-values.yaml.j2"
        delegate_to: 127.0.0.1
        when: state == "present" and item.value.values is defined
        become: "{{ become_local_user }}"
        become_user: "{{ local_user }}"

      - name: Deploy helm charts
        kubernetes.core.helm:
          kubeconfig: "{{ path_to_kubeconfig }}"
          name: "{{ item.key }}"
          chart_ref: "{{ item.value.ref }}"
          chart_version: "{{ item.value.version | default('latest') }}"
          release_namespace: "{{ item.value.namespace }}"
          create_namespace: true
          state: "{{ state | default('present') }}"
          values: "{{ lookup('template', '{{ tmp_dir }}/{{ item.key }}-values.yaml.j2') | from_yaml | default(omit) }}"
          wait: "{{ item.values.wait | default(omit) }}"
        when: helm_releases is defined
        ignore_errors: "{{ item.value.ignore | default(omit) }}"

      - name: Wait until pods are running
        kubernetes.core.k8s_info:
          kubeconfig: "{{ path_to_kubeconfig }}"
          api_version: v1
          kind: Pod
          namespace: "{{ item.value.namespace }}"
        register: pod_list
        retries: "{{ item.value.wait_retries | default(10) }}"
        delay: "{{ item.value.wait_delay | default(5) }}"
        until: (pod_list is defined) and
               (pod_list.resources | default([]) | length > 0) and
               ("Running" in (pod_list | json_query('resources[*].status.phase')))
        when: state == "present" and item.value.namespace is defined

      - name: Wait for webhooks beeing ready
        ansible.builtin.wait_for:
          timeout: "{{ webhook_wait | default(0) }}"

      - name: Check for CRDs
        ansible.builtin.command: >
          kubectl get crd "{{ item }}" --no-headers -o name
        environment:
          KUBECONFIG: "{{ path_to_kubeconfig }}"
        register: crd_check
        until: crd_check.rc == 0
        retries: "{{ max_retries | default (25) }}"
        delay: "{{ delay_seconds | default (5) }}"
        ignore_errors: true
        loop: "{{ crd_checks }}"
        changed_when: false
        when: crd_checks is defined

  - name: manifests
    play: |
      ---
      - name: Create template on disk
        ansible.builtin.copy:
          content: "{{ item.value }}"
          dest: "/tmp/{{ item.key }}.yaml.j2"
        delegate_to: 127.0.0.1
        become: "{{ become_local_user }}"
        become_user: "{{ local_user }}"
        when: state == "present"

      - name: Deploy additional manifests
        kubernetes.core.k8s:
          kubeconfig: "{{ path_to_kubeconfig }}"
          state: "{{ state | default('present') }}"
          definition: "{{ lookup('template', '/tmp/{{ item.key }}.yaml.j2') | from_yaml }}"

  - name: send_events_homerun
    play: |
      ---
      - name: Send mock events and/or probe URLs
        hosts: "{{ target_host | default('all') }}"
        gather_facts: false
      
        vars:
          delay: 5
          validate_certs: false
          method: "GET"
      
          # Mock mode variables
          count_messages: 5
          homerun_address: ""   # If defined, mock mode runs
          homerun_token: ""
          systems: ["github", "gitlab"]
          titles: ["System Alert", "System Incident", "Incident"]
          messages: ["Memory usage is high", "CPU usage is high", "Memory and CPU usage is high"]
          severities: ["INFO", "ERROR", "WARNING"]
          authors: ["bibi", "gude", "andreu", "qolf", "pat"]
          artifacts: ["image-1.23.tar.gz", "test.tar.gz", "report.json", "result.txt"]
          message_tags: ["usage,alert", "cpu", "cpu,usage,alert", "memory,usage,alert", "monitoring,usage,alert,memory"]
          domains: ["example.com", "test.com", "mail.com", "demo.com"]
      
          # test url mode variables
          raw_url: ""           # Single URL
          raw_urls: ""          # Comma-separated URLs
      
        tasks:
      
          # ---------------------- MOCK MODE ----------------------
          - name: Send random messages to Homerun app
            when: homerun_address | length > 0
            block:
              - name: POST random mock event
                uri:
                  url: "{{ homerun_address }}"
                  method: POST
                  headers:
                    Content-Type: "application/json"
                    X-Auth-Token: "{{ homerun_token }}"
                  body_format: json
                  validate_certs: "{{ validate_certs }}"
                  body: >-
                    {{
                      {
                        "title": (titles | random),
                        "message": (messages | random),
                        "severity": (severities | random),
                        "author": (authors | random),
                        "timestamp": "%04d-%02d-%02dT%02d:%02d:%02dZ" | format(
                          2024 + (range(0,10)|random),
                          (range(1,13)|random),
                          (range(1,29)|random),
                          (range(0,24)|random),
                          (range(0,60)|random),
                          (range(0,60)|random)
                        ),
                        "system": (systems | random),
                        "tags": (message_tags | random),
                        "assigneeaddress": (lookup('password', '/dev/null chars=ascii_letters,digits length=8')) ~ '@' ~ (domains | random),
                        "assigneename": (authors | random),
                        "artifacts": (artifacts | random),
                        "url": "http://" ~ (lookup('password', '/dev/null chars=ascii_letters,digits length=6')) ~ '.' ~ (domains | random) ~ '/' ~ (lookup('password', '/dev/null chars=ascii_letters,digits length=10'))
                      }
                    }}
                register: response
                loop: "{{ range(1, count_messages + 1) | list }}"
                loop_control:
                  index_var: idx
                retries: 3
                delay: "{{ delay }}"
                until: response.status == 200
      
          # ---------------------- TEST URL MODE ----------------------
          - name: Normalize test URLs
            when: raw_url | length > 0 or raw_urls | length > 0
            set_fact:
              test_urls: >-
                {{
                  (
                    ([raw_url] if raw_url | length > 0 else [])
                    + (raw_urls.split(',') if raw_urls | length > 0 else [])
                  )
                  | map('regex_replace', '^\s+|\s+$', '')
                  | select('match', '^https?://')
                  | list
                }}
      
          - name: Show test URLs
            when: test_urls is defined and test_urls | length > 0
            debug:
              var: test_urls
      
          - name: Test each raw URL
            when: test_urls is defined and test_urls | length > 0
            uri:
              url: "{{ item }}"
              method: "{{ method }}"
              validate_certs: "{{ validate_certs }}"
            register: test_urls_results
            loop: "{{ test_urls }}"
            loop_control:
              label: "{{ item }}"
            retries: 3
            delay: "{{ delay }}"
            until: test_urls_results.status == 200
      
          - name: Summary
            debug:
              msg: >-
                {% if homerun_address | length > 0 %}
                Sent {{ count_messages }} mock messages to {{ homerun_address }}.
                {% endif %}
                {% if test_urls is defined and test_urls | length > 0 %}
                Probed {{ test_urls | length }} URL(s): {{ test_urls | join(', ') }}.
                {% endif %}

  - name: provision_edge
    play: | # pragma: allowlist secret
      - hosts: localhost
        gather_facts: false
        vars:
          controller_user: pat
        tasks:
          - name: Generate SSH keypair for controller or remote user
            community.crypto.openssh_keypair:
              path: "/home/{{ controller_user }}/.ssh/id_ed25519"
              type: ed25519
              comment: "{{ controller_user }}@ansible-controller"
              state: present
              mode: '0600'
            register: controller_keypair
      
      - hosts: "{{ target_host | default('all') }}"
        gather_facts: false
        vars:
          controller_user: pat
        tasks:
          - name: Add target host fingerprint to controller's known_hosts
            ansible.builtin.known_hosts:
              path: "/home/{{ controller_user }}/.ssh/known_hosts"
              name: "{{ hostvars[item].ansible_host | default(item) }}"
              key: "{{ lookup('pipe', 'ssh-keyscan -H ' + (hostvars[item].ansible_host | default(item))) }}"
              state: present
            loop: "{{ groups['initial_master_node'] }}"
            when: item != 'localhost'
            delegate_to: localhost
      
          - name: Add controller public key to remote authorized_keys
            ansible.posix.authorized_key:
              user: "{{ ansible_user | default('sthings') }}"
              state: present
              key: "{{ hostvars['localhost'].controller_keypair.public_key }}"
      
      - hosts: "{{ target_host | default('all') }}"
        become: true
        vars:
          ansible_user: sthings
        tasks:
          - name: Ensure .ssh directory exists for sthings
            ansible.builtin.file:
              path: "/home/{{ ansible_user }}/.ssh"
              state: directory
              owner: "{{ ansible_user }}"
              group: "{{ ansible_user }}"
              mode: '0700'
            when: inventory_hostname != 'localhost'
      
          - name: Add host fingerprint to remote user's known_hosts
            ansible.builtin.known_hosts:
              path: "/home/{{ ansible_user }}/.ssh/known_hosts"
              name: "{{ inventory_hostname }}"
              key: "{{ lookup('pipe', 'ssh-keyscan -H ' + inventory_hostname) }}"
              state: present
            when: inventory_hostname != 'localhost'
      
          - name: Ensure SSH public key is present on target
            ansible.builtin.authorized_key:
              user: "{{ ansible_user }}"
              state: present
              key: "{{ hostvars['localhost'].controller_keypair.public_key }}"
            when: inventory_hostname != 'localhost'
      
      - name: Create kind-cluster
        ansible.builtin.import_playbook: sthings.container.kind
        vars:
          kind_cluster_name: "{{ k8s_cluster_name | default('dev') }}"
          deployment_vars: "{{ kind_deployment_vars | default('Nil') }}"
          ansible_user: sthings
          count_worker_nodes: 3
          count_controlplane_nodes: 1
          kubectl_version: "{{ kind_kubectl_version | default('1.34.0') }}"
          kind_version: "{{ k8s_kind_version | default('0.30.0') }}"
          enable_ingress_ports: true
          enable_host_paths: true
          provision_cluster: true
          docker_install_compose: true
          install_kind: true
          path_to_kubeconfig: "{{ k8s_kubeconfig_path | default('/home/sthings/.kube/test') }}"
        when: cluster_type | default('kind') == 'kind'
      
      - name: Create k3s-cluster
        ansible.builtin.import_playbook: sthings.rke.k3s
        vars:
          target_host: localhost
          k3s_cluster_name: "{{ k8s_cluster_name | default('dev') }}"
          deployment_vars: "{{ kind_deployment_vars | default('Nil') }}"
          ansible_user: sthings
          install_k3s: true
          k3s_state: present
          k3s_k8s_version: "{{ k3s_cluster_version | default('1.34.1') }}"
          fetched_kubeconfig_path: "{{ k8s_fetch_kubeconfig_path | default('/home/sthings/.kube/test') }}"
          k3s_release_kind: k3s1
          cluster_setup: singlenode
          install_cillium: true
          deploy_helm_charts: true
          state: present
        when: cluster_type | default('kind') == 'k3s'
      
      
      - name: GUI - Deploy Headlamp
        ansible.builtin.import_playbook: sthings.container.deploy_to_k8s
        vars:
          deployment_namespace: "{{ headlamp_deployment_namespace | default('kube-system') }}"
          headlamp_version: "{{ headlamp_version | default('0.33.0') }}"
          path_to_kubeconfig: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
          domain: "{{ headlamp_domain | default('example.com') }}"
          issuer_name: "{{ headlamp_issuer_name | default('selfsigned') }}"
          create_cert_resource: false
          issuer_annotation: ClusterIssuer
          path: "~/.ansible/collections/ansible_collections/sthings/container/playbooks/vars"
          profile: "{{ headlamp_profile | default('headlamp') }}"
          ansible_user: sthings
      
      - name: Monitoring - Deploy Loki
        ansible.builtin.import_playbook: sthings.container.deploy_to_k8s
        vars:
          deployment_namespace: "{{ monitoring_deployment_namespace | default('observability') }}"
          loki_version: "{{ monitoring_loki_version | default('6.31.0') }}"
          path_to_kubeconfig: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
          path: "~/.ansible/collections/ansible_collections/sthings/container/playbooks/vars"
          profile: "{{ loki_profile | default('loki') }}"
          state: present
          ansible_user: sthings
      
      - name: Monitoring - Deploy Promtail
        ansible.builtin.import_playbook: sthings.container.deploy_to_k8s
        vars:
          deployment_namespace: "{{ monitoring_deployment_namespace | default('observability') }}"
          promtail_version: "{{ monitoring_promtail_version | default('6.17.0') }}"
          lokiServiceName: "{{ promtail_lokiServiceName | default('loki') }}"
          lokiNamespace: "{{ promtail_lokiNamespace | default('observability') }}"
          path_to_kubeconfig: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
          path: "~/.ansible/collections/ansible_collections/sthings/container/playbooks/vars"
          profile: "{{ promtail_profile | default('promtail') }}"
          state: present
          ansible_user: sthings
      
      - name: Monitoring - Deploy Grafana
        ansible.builtin.import_playbook: sthings.container.deploy_to_k8s
        vars:
          deployment_namespace: "{{ monitoring_deployment_namespace | default('observability') }}"
          grafana_version: "{{ monitoring_grafana_version | default('7.3.9') }}"
          hostname: "{{ grafana_hostname | default('grafana') }}"
          domain: "{{ grafana_domain | default('example.com') }}"
          path_to_kubeconfig: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
          issuer_name: "{{ grafana_issuer_name | default('selfsigned') }}"
          storage_class_name: "{{ grafana_storage_class_name | default('standard') }}"
          create_cert_resource: false
          ingress_enabled: "{{ grafana_ingress_enabled | default('true') }}"
          path: "~/.ansible/collections/ansible_collections/sthings/container/playbooks/vars"
          profile: "{{ grafana_profile | default('grafana') }}"
          state: present
          ansible_user: sthings
      
      - name: Homerun - Deploy Base-Stack
        ansible.builtin.import_playbook: sthings.container.deploy_to_k8s
        vars:
          deployment_namespace: "{{ base_stack_deployment_namespace | default('homerun') }}"
          homerun_chart_version: "{{ base_stack_chart_version | default('v0.2.1') }}"
          genericPitcherEnabled: "{{ base_stack_genericPitcherEnabled | default(true) }}"
          textCatcherEnabled: "{{ base_stack_textCatcherEnabled | default(true) }}"
          genericPitcherDomain: "{{ base_stack_genericPitcherDomain | default('demo-infra.example.com') }}"
          redisStackServiceName: "{{ base_stack_redisStackServiceName | default('redis-stack-headless') }}"
          redisStackPassword: "{{ base_stack_redisStackPassword | default('example-password') }}"
          redisStackServiceType: "{{ base_stack_redisStackServiceType | default('ClusterIP') }}"
          redisStackStorageClass: "{{ base_stack_redisStackStorageClass | default('standard') }}"
          redisStackVersion: "{{ base_stack_redisStackVersion | default('7.2.0-v18 #6.2.6-v9') }}"
          genericPitcherToken: "{{ base_stack_genericPitcherToken | default('example-token') }}"
          issuer_annotation: ClusterIssuer
          genericPitcherIssuerName: "{{ base_stack_genericPitcherIssuerName | default('selfsigned') }}"
          path_to_kubeconfig: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
          path: "~/.ansible/collections/ansible_collections/sthings/container/playbooks/vars"
          profile: "{{ base_stack_profile | default('homerun-base-stack') }}"
          state: present
          ansible_user: sthings
      
      - hosts: "{{ target_host | default('all') }}"
        gather_facts: true
        vars:
          redis_password: "{{ base_stack_redisStackPassword | default('example-password') }}"
          redis_index_name: "homerun"
        environment:
          KUBECONFIG: "{{ kubeconfig_path | default('/home/sthings/.kube/test') }}"
        tasks:
          - name: Install redis-tools
            ansible.builtin.apt:
              name: redis-tools
              state: present
            become: true
      
          - name: Port-forward Redis service
            ansible.builtin.command:
              cmd: kubectl port-forward -n homerun svc/redis-stack 6379:6379
            async: 60
            poll: 0
            register: port_forward_job
      
          - name: Wait for port-forward to be ready
            ansible.builtin.wait_for:
              host: localhost
              port: 6379
              timeout: 30
      
          - name: Check existing RedisSearch indexes
            ansible.builtin.shell: |
              redis-cli -h localhost -p 6379 -a {{ redis_password }} "FT._LIST"
            register: redis_list_result
      
          - name: Create RedisSearch index if missing
            ansible.builtin.shell: |
              redis-cli -h localhost -p 6379 -a {{ redis_password }} \
              FT.CREATE {{ redis_index_name }} ON HASH PREFIX 1 message: SCHEMA messageID TEXT SORTABLE timestamp NUMERIC SORTABLE
            when: redis_index_name not in redis_list_result.stdout_lines
            register: redis_index_result
      
          - name: List RedisSearch indexes
            ansible.builtin.shell: |
              redis-cli -h localhost -p 6379 -a {{ redis_password }} "FT._LIST"
            register: redis_list_result
      
          - name: Show RedisSearch indexes
            ansible.builtin.debug:
              var: redis_list_result.stdout
      
          - name: Terminate port-forward process
            ansible.builtin.shell: |
              kill $(ps aux | grep '[k]ubectl port-forward -n homerun svc/redis-stack 6379:6379' | awk '{print $2}')
            ignore_errors: true
      
      - name: Homerun - Mock + Test Urls 
        ansible.builtin.import_playbook: sthings.container.send_events_homerun
        vars:
          # Mock
          homerun_address: "{{ HOMERUN_ADDRESS | default('https://homerun.{{ base_stack_genericPitcherDomain }}/generic') }}"
          homerun_token: "{{ base_stack_genericPitcherToken | default('example-token') }}"
          count_messages: 5
      
          # Test URLs
          raw_urls: >
            https://headlamp.{{ headlamp_domain }},
            https://grafana.{{ grafana_domain }}
          validate_certs: false
          method: "GET"
          delay: 3
