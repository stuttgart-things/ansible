---
playbooks:
  - name: deploy_to_k8s
    play: |
      ---
      - hosts: "{{ target_host | default('localhost') }}"
        become: true
        vars:
          tmp_dir: "{{ '~' if ansible_user_id == 'nonroot' else '/tmp' }}"
          local_user: "{{ ansible_user }}"
          become_local_user: true

        vars_files:
          - "{{ path | default('.') }}/{{ profile }}.yaml"
          #- "{{ deployment_vars }}"

        tasks:
          - name: Create pre manifests
            ansible.builtin.include_tasks: manifests.yaml
            loop: "{{ q('ansible.builtin.dict', pre_manifests) }}"
            when: pre_manifests is defined

          - name: Configure and (un)install helm charts
            block:
              - name: Install helm requirements
                ansible.builtin.include_tasks: helm_config.yaml

              - name: Deploy helm chart(s)
                ansible.builtin.include_tasks: helm.yaml
                loop: "{{ q('ansible.builtin.dict', helm_releases) }}"
            when: helm_releases is defined

          - name: Create post manifests
            ansible.builtin.include_tasks: manifests.yaml
            loop: "{{ q('ansible.builtin.dict', post_manifests) }}"
            when: post_manifests is defined

  - name: helm_config
    play: |
      ---
      - name: Add helm chart repositories
        kubernetes.core.helm_repository:
          name: "{{ item.key }}"
          repo_url: "{{ item.value.url }}"
          force_update: true
        loop: "{{ q('ansible.builtin.dict', helm_repositories) }}"
        when: helm_repositories is defined and state == "present"

      - name: Install Helm Diff
        kubernetes.core.helm_plugin:
          plugin_path: "https://github.com/databus23/helm-diff"
          state: present
        when: state == "present"

  - name: helm
    play: |
      ---
      - name: Create helm values on disk
        ansible.builtin.copy:
          content: "{{ item.value.release_values }}" #().0
          dest: "{{ tmp_dir }}/{{ item.key }}-values.yaml.j2"
        delegate_to: 127.0.0.1
        when: state == "present" and item.value.values is defined
        become: "{{ become_local_user }}"
        become_user: "{{ local_user }}"

      - name: Deploy helm charts
        kubernetes.core.helm:
          kubeconfig: "{{ path_to_kubeconfig }}"
          name: "{{ item.key }}"
          chart_ref: "{{ item.value.ref }}"
          chart_version: "{{ item.value.version | default('latest') }}"
          release_namespace: "{{ item.value.namespace }}"
          create_namespace: true
          state: "{{ state | default('present') }}"
          values: "{{ lookup('template', '{{ tmp_dir }}/{{ item.key }}-values.yaml.j2') | from_yaml | default(omit) }}"
          wait: "{{ item.values.wait |
          default(omit) }}"
        when: helm_releases is defined
        ignore_errors: "{{ item.value.ignore | default(omit) }}"

      - name: Wait until pods are running
        kubernetes.core.k8s_info:
          kubeconfig: "{{ path_to_kubeconfig }}"
          api_version: v1
          kind: Pod
          namespace: "{{ item.value.namespace }}"
          wait_sleep: 30
          wait_timeout: 360
        register: pod_list
        retries: "{{ item.values.wait_retries | default(15) }}"
        delay: "{{ item.values.wait_delay | default(30) }}"
        until: pod_list|json_query('resources[*].status.phase')|unique == ["Running"]
        when: state == "present" and item.value.values is defined

      - name: Wait for webhooks beeing ready
        ansible.builtin.wait_for:
          timeout: "{{ webhook_wait | default(0) }}"

      - name: Check for CRDs
        ansible.builtin.command: >
          kubectl get crd "{{ item }}" --no-headers -o name
        environment:
          KUBECONFIG: "{{ path_to_kubeconfig }}"
        register: crd_check
        until: crd_check.rc == 0
        retries: "{{ max_retries | default (25) }}"
        delay: "{{ delay_seconds | default (5) }}"
        ignore_errors: true
        loop: "{{ crd_checks }}"
        changed_when: false
        when: crd_checks is defined

  - name: manifests
    play: |
      ---
      - name: Create template on disk
        ansible.builtin.copy:
          content: "{{ item.value }}"
          dest: "/tmp/{{ item.key }}.yaml.j2"
        delegate_to: 127.0.0.1
        become: "{{ become_local_user }}"
        become_user: "{{ local_user }}"
        when: state == "present"

      - name: Deploy additional manifests
        kubernetes.core.k8s:
          kubeconfig: "{{ path_to_kubeconfig }}"
          state: "{{ state | default('present') }}"
          definition: "{{ lookup('template', '/tmp/{{ item.key }}.yaml.j2') | from_yaml }}"
