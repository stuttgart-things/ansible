---
vars:
  - name: cert-manager
    file: |
      ---
      deployment_namespace: cert-manager
      helm_repositories:
        cert-manager:
          url: https://charts.jetstack.io

      helm_releases:
        cert-manager:
          ref: cert-manager/cert-manager
          version: v1.17.1
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            installCRDs: true

      post_manifests: {}

  - name: ingress-nginx
    file: |
      ---
      ingress_nginx_version: 4.10.1
      deployment_namespace: ingress-nginx
      helm_repositories:
        ingress-nginx:
          url: https://kubernetes.github.io/ingress-nginx

      post_manifests: {}

      helm_releases:
        ingress-nginx:
          ref: ingress-nginx/ingress-nginx
          version: "{{ ingress_nginx_version }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: {}

  - name: rancher
    file: |
      ---
      rancher_version: 2.8.5
      deployment_namespace: cattle-system
      helm_repositories:
        rancher-stable:
          url: https://releases.rancher.com/server-charts/latest

      helm_releases:
        rancher:
          ref: rancher-stable/rancher
          version: "{{ rancher_version }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            global:
              cattle:
                psp:
                  enabled: false
            bootstrapPassword: {{ password }}
            hostname: {{ hostname }}.{{ domain }}
            privateCA: true
            ingress:
              enabled: true
              ingressClassName: nginx
              servicePort: 80
              tls:
                source: secret
                secretName: {{ hostname }}-tls

  - name: headlamp
    file: |
      ---
      headlamp_version: 0.33.0
      deployment_namespace: kube-system
      hostname: headlamp
      issuer_name: selfsigned
      create_cert_resource: false

      helm_repositories:
        headlamp:
          url: https://kubernetes-sigs.github.io/headlamp/

      helm_releases:
        headlamp:
          ref: headlamp/headlamp
          version: "{{ headlamp_version | default('0.33.0') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            ingress:
              enabled: {{ ingress_enabled | default(true) }}
              ingressClassName: {{ ingress_class_name | default('nginx') }}
            {% if not create_cert_resource %}
              annotations:
                cert-manager.io/{{ issuer_annotation | default('cluster-issuer') }}: "{{ issuer_name }}"
            {% endif %}
              hosts:
                - host: {{ hostname }}.{{ domain }}
                  paths:
                    - path: /
                      type: ImplementationSpecific
              tls:
                - secretName: {{ hostname }}-ingress-tls
                  hosts:
                    - {{ hostname }}.{{ domain }}

        headlamp-app-configuration:
          ref: oci://ghcr.io/stuttgart-things/sthings-cluster
          version: "{{ sthings_cluster_chart_version | default('0.3.15') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            serviceAccounts:
              headlamp-admin:
                namespace: {{ deployment_namespace }}

            clusterRoleBindings:
              headlamp-cluster-admin:
                roleRef:
                  kind: ClusterRole
                  name: cluster-admin
                  apiGroup: rbac.authorization.k8s.io
                subjects:
                  - kind: ServiceAccount
                    name: headlamp-admin
                    namespace: {{ deployment_namespace }}

            {% if create_cert_resource %}
            customresources:
              ingress-certificate-headlamp:
                apiVersion: cert-manager.io/v1
                kind: Certificate
                metadata:
                  name: headlamp-ingress
                  namespace: {{ deployment_namespace }}
                spec:
                  commonName: {{ hostname }}.{{ domain }}
                  dnsNames:
                    - {{ hostname }}.{{ domain }}
                  issuerRef:
                    name: {{ issuer_name }}
                    kind: {{ issuer_annotation | default('cluster-issuer') }}
                  secretName: {{ hostname }}-ingress-tls
            {% endif %}

      post_manifests: {}

  - name: loki
    file: |
      ---
      loki_version: 6.31.0
      deployment_namespace: observability
      profile: fs

      helm_repositories:
        grafana:
          url: https://grafana.github.io/helm-charts

      helm_releases:
        loki:
          ref: grafana/loki
          version: "{{ loki_version | default('6.31.0') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            loki:
              auth_enabled: {{ auth_enabled | default('false') }}

              commonConfig:
                replication_factor:  {{ replication_factor | default('1') }}

              storage:
                type: "{{ storage_type | default('filesystem') }}"
                bucketNames:
                  chunks: "ignored"
                  ruler: "ignored"
                  admin: "ignored"

              storage_config:
                filesystem:
                  directory: {{ filesystem_directory | default('/var/loki/chunks') }}

              schemaConfig:
                configs:
                  - from: "{{ schemaConfig_configs_from | default('2024-04-01') }}"
                    store: {{ schemaConfig_configs_store | default('tsdb') }}
                    object_store: {{ schemaConfig_configs_object_store | default('filesystem') }}
                    schema: {{ schemaConfig_configs_schema | default('v13') }}
                    index:
                      prefix: {{ schemaConfig_index_prefix | default('loki_index_') }}
                      period: {{ schemaConfig_index_period | default('24h') }}

              pattern_ingester:
                  enabled: {{ pattern_ingester_enabled | default('true') }}
              limits_config:
                allow_structured_metadata: {{ limits_config_allow_structured_metadata | default('true') }}
                volume_enabled: {{ limits_config_volume_enabled | default('true') }}
              ruler:
                enable_api: {{ ruler_enable_api | default('true') }}

            minio:
              enabled: {{ minio_enabled | default('false') }}

            deploymentMode: {{ deployment_mode | default('SingleBinary') }}

            singleBinary:
              replicas: {{ singleBinary_replicas | default('1') }}

            # Zero out replica counts of other deployment modes
            backend:
              replicas: {{ backend_replicas | default('0') }}
            read:
              replicas: {{ read_replicas | default('0') }}
            write:
              replicas: {{ write_replicas | default('0') }}

            ingester:
              replicas: {{ ingester_replicas | default('0') }}
            querier:
              replicas: {{ querier_replicas | default('0') }}
            queryFrontend:
              replicas:  {{ queryFrontend_replicas | default('0') }}
            queryScheduler:
              replicas: {{ queryScheduler_replicas | default('0') }}
            distributor:
              replicas: {{ distributor_replicas | default('0') }}
            compactor:
              replicas: {{ compactor_replicas | default('0') }}
            indexGateway:
              replicas: {{ indexGateway_replicas | default('0') }}
            bloomCompactor:
              replicas: {{ bloomCompactor_replicas | default('0') }}
            bloomGateway:
              replicas: {{ bloomGateway_replicas | default('0') }}

            chunksCache:
              enabled: {{ chunksCache_enabled | default('false') }}

            gateway:
              enabled: {{ gateway_enabled | default('false') }}

            resultsCache:
              enabled: {{ resultsCache_enabled | default('false') }}

      post_manifests: {}

  - name: promtail
    file: |
      ---
      promtail_version: 6.17.0
      deployment_namespace: observability
      lokiServiceName: loki
      lokiNamespace: observability

      helm_repositories:
        grafana:
          url: https://grafana.github.io/helm-charts

      helm_releases:
        promtail:
          ref: grafana/promtail
          version: "{{ promtail_version | default('6.17.0') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            config:
              clients:
                - url: http://{{ lokiServiceName }}.{{ lokiNamespace }}.svc.cluster.local:3100/loki/api/v1/push
                  tenant_id: "{{ tenant_id | default('default') }}"
              positions:
                filename: "{{ positions_filename | default('/var/log/positions.yaml') }}"

            podLabels:
              app: "{{ podLabels_app | default('promtail') }}"

            tolerations:
              - key: "{{ tolerations_key | default('node-role.kubernetes.io/control-plane') }}"
                operator: "{{ tolerations_operator | default('Exists') }}"
                effect: "{{ tolerations_effect | default('NoSchedule') }}"

            rbac:
              create: "{{ rbac_create | default('true') }}"

            serviceAccount:
              create: {{ serviceAccount_create | default('true') }}
              name: "{{ serviceAccount_name | default('promtail') }}"

      post_manifests: {}

  - name: grafana
    file: |
      ---
      grafana_version: 7.3.9
      deployment_namespace: observability
      hostname: grafana
      issuer_name: selfsigned
      create_cert_resource: false
      ingress_enabled: true
      size: 1
      enable_persistence: true
      nodePortHttp: 30084

      helm_repositories:
        grafana:
          url: https://grafana.github.io/helm-charts

      helm_releases:
        grafana:
          ref: grafana/grafana
          version: "{{ grafana_version | default('7.3.9') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            {% if ingress_enabled %}
            ingress:
              enabled: {{ ingress_enabled | default(true) }}
              ingressClassName: "{{ ingress_class_name | default('nginx') }}"
            {% if not create_cert_resource %}
              annotations:
                cert-manager.io/{{ issuer_annotation | default('cluster-issuer') }}: "{{ issuer_name }}"
            {% endif %}
              labels: {{ ingress_labels | default('{}') }}
              path: {{ ingress_path | default('/') }}
              pathType: "{{ ingress_pathtype | default('Prefix') }}"
              hosts:
                - {{ hostname }}.{{ domain }}
              tls:
                - secretName: {{ hostname }}-ingress-tls
                  hosts:
                    - {{ hostname }}.{{ domain }}
            {% endif %}

            initChownData:
              enabled: {{ initchowndata_enabled | default('false') }}

            {% if enable_persistence %}
            persistence:
              enabled: {{ persistence_enabled | default('true') }}
              storageClassName: "{{ storage_class_name | default('standard') }}"
              accessModes:
                - ReadWriteOnce
              size: {{ persistence_size | default('1') }}Gi
              finalizers:
                - kubernetes.io/pvc-protection
              extraPvcLabels: {}
              disableWarning: false
            {% endif %}

            service:
              type: "{{ service_type | default('ClusterIP') }}"
            {% if nodePortHttp %}
              nodePort: "{{ nodePortHttp | default('30084') }}"
            {% endif %}

        grafana-app-configuration:
          ref: oci://ghcr.io/stuttgart-things/sthings-cluster
          version: "{{ sthings_cluster_chart_version | default('0.3.15') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            {% if create_cert_resource %}
            customresources:
              ingress-certificate-grafana:
                apiVersion: cert-manager.io/v1
                kind: Certificate
                metadata:
                  name: grafana-ingress
                  namespace: {{ deployment_namespace }}
                spec:
                  commonName: {{ hostname }}.{{ domain }}
                  dnsNames:
                    - {{ hostname }}.{{ domain }}
                  issuerRef:
                    name: {{ issuer_name }}
                    kind: {{ issuer_annotation | default('cluster-issuer') }}
                  secretName: {{ hostname }}-ingress-tls
            {% endif %}

      post_manifests: {}

  - name: homerun-base-stack
    file: | # pragma: allowlist secret
      ---
      deployment_namespace: homerun
      genericPitcherEnabled: true
      textCatcherEnabled: true

      helm_releases:
        redis:
          ref: "oci://ghcr.io/stuttgart-things/charts/redis/redis"
          version: "{{ redis_chart_version | default('17.1.4') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            fullnameOverride: redis-stack
            global:
              redis:
                password: {{ redisStackPassword }}

            sentinel:
              enabled: true
              masterSet: mymaster
              quorum: 1
              parallelSyncs: 1
              service:
                type: {{ redisStackServiceType | default('ClusterIP') }}
              image:
                registry: {{ imageRegistrySentinel | default('ghcr.io') }}
                repository: {{ imageRepositorySentinel | default('stuttgart-things/redis-sentinel') }}
                tag: {{ redisSentinelVersion | default('7.4.2-debian-12-r9 # 7.0.4-debian-11-r14') }}

            image:
              registry: {{ imageRegistry | default('ghcr.io') }}
              repository: {{ imageRepository | default('stuttgart-things/redis-stack-server') }}
              tag: {{ redisStackVersion | default('7.2.0-v18 #6.2.6-v9') }}

            master:
              persistence:
                enabled: {{ persistenceEnabled | default('true') }}
                storageClass: {{ redisStackStorageClass | default('standard') }}
                size: {{ redisStackStorageSize | default('8Gi') }}
              args:
                - -c
                - /opt/bitnami/scripts/merged-start-scripts/start-master.sh
              extraVolumes:
                - name: merged-start-scripts
                  configMap:
                    name: bitnami-redis-stack-server-merged
                    defaultMode: 0755
              extraVolumeMounts:
                - name: merged-start-scripts
                  mountPath: /opt/bitnami/scripts/merged-start-scripts
            replica:
              persistence:
                enabled: {{ persistenceEnabled | default('true') }}
                storageClass: {{ redisStackStorageClass | default('standard') }}
                size: {{ redisStackStorageSize | default('8Gi') }}

              replicaCount: 1
              args:
                - -c
                - /opt/bitnami/scripts/merged-start-scripts/start-replica.sh
              extraVolumes:
                - name: merged-start-scripts
                  configMap:
                    name: bitnami-redis-stack-server-merged
                    defaultMode: 0755
              extraVolumeMounts:
                - name: merged-start-scripts
                  mountPath: /opt/bitnami/scripts/merged-start-scripts
            extraDeploy:
              - apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: bitnami-redis-stack-server-merged
                data:
                  start-master.sh: |
                    #!/usr/bin/dumb-init /bin/bash
                    ### docker entrypoint script, for starting redis stack
                    BASEDIR=/opt/redis-stack
                    cd ${BASEDIR}
                    CMD=${BASEDIR}/bin/redis-server
                    if [ -z "${REDISEARCH_ARGS}" ]; then
                    REDISEARCH_ARGS="MAXSEARCHRESULTS 10000 MAXAGGREGATERESULTS 10000"
                    fi
                    [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD="$(< "${REDIS_PASSWORD_FILE}")"
                    if [[ -f /opt/bitnami/redis/mounted-etc/master.conf ]];then
                        cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf
                    fi
                    if [[ -f /opt/bitnami/redis/mounted-etc/redis.conf ]];then
                        cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf
                    fi
                    ${CMD} \
                    --port "${REDIS_PORT}" \
                    --requirepass "${REDIS_PASSWORD}" \
                    --masterauth "${REDIS_PASSWORD}" \
                    --include "/opt/bitnami/redis/etc/redis.conf" \
                    --include "/opt/bitnami/redis/etc/master.conf" \
                    --loadmodule /opt/redis-stack/lib/redisearch.so ${REDISEARCH_ARGS} \
                    --loadmodule /opt/redis-stack/lib/redistimeseries.so ${REDISTIMESERIES_ARGS} \
                    --loadmodule /opt/redis-stack/lib/rejson.so ${REDISJSON_ARGS} \
                    --loadmodule /opt/redis-stack/lib/redisbloom.so ${REDISBLOOM_ARGS}
                  start-replica.sh: |
                    #!/usr/bin/dumb-init /bin/bash
                    BASEDIR=/opt/redis-stack
                    cd ${BASEDIR}
                    CMD=${BASEDIR}/bin/redis-server
                    get_port() {
                        hostname="$1"
                        type="$2"
                        port_var=$(echo "${hostname^^}_SERVICE_PORT_$type" | sed "s/-/_/g")
                        port=${!port_var}
                        if [ -z "$port" ]; then
                            case $type in
                                "SENTINEL")
                                    echo 26379
                                    ;;
                                "REDIS")
                                    echo 6379
                                    ;;
                            esac
                        else
                            echo $port
                        fi
                    }
                    get_full_hostname() {
                        hostname="$1"
                        echo "${hostname}.${HEADLESS_SERVICE}"
                    }
                    REDISPORT=$(get_port "$HOSTNAME" "REDIS")
                    [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD="$(< "${REDIS_PASSWORD_FILE}")"
                    [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD="$(< "${REDIS_MASTER_PASSWORD_FILE}")"
                    if [[ -f /opt/bitnami/redis/mounted-etc/replica.conf ]];then
                        cp /opt/bitnami/redis/mounted-etc/replica.conf /opt/bitnami/redis/etc/replica.conf
                    fi
                    if [[ -f /opt/bitnami/redis/mounted-etc/redis.conf ]];then
                        cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf
                    fi
                    echo "" >> /opt/bitnami/redis/etc/replica.conf
                    echo "replica-announce-port $REDISPORT" >> /opt/bitnami/redis/etc/replica.conf
                    echo "replica-announce-ip $(get_full_hostname "$HOSTNAME")" >> /opt/bitnami/redis/etc/replica.conf
                    ${CMD} \
                    --port "${REDIS_PORT}" \
                    --requirepass "${REDIS_PASSWORD}" \
                    --masterauth "${REDIS_PASSWORD}" \
                    --include "/opt/bitnami/redis/etc/redis.conf" \
                    --include "/opt/bitnami/redis/etc/replica.conf" \
                    --loadmodule /opt/redis-stack/lib/redisearch.so ${REDISEARCH_ARGS} \
                    --loadmodule /opt/redis-stack/lib/redistimeseries.so ${REDISTIMESERIES_ARGS} \
                    --loadmodule /opt/redis-stack/lib/rejson.so ${REDISJSON_ARGS} \
                    --loadmodule /opt/redis-stack/lib/redisbloom.so ${REDISBLOOM_ARGS}
        generic-pitcher:
          ref: "oci://ghcr.io/stuttgart-things/homerun"
          version: "{{ homerun_chart_version | default('v0.2.1') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            generic-pitcher:
              enabled: {{ genericPitcherEnabled }}

              configmaps:
                homerun-generic-pitcher:
                  API_PATH: "{{ genericPitcherApiPath | default('generic') }}"
                  PORT: "{{ genericPitcherContainerPort | default('4000') }}"
                  REDIS_STREAM: "{{ stream | default('homerun') }}"
                  REDISEARCH_INDEX: "{{ searchIndex | default('homerun') }}"

              secrets:
                generic-token:
                  name: generic-token
                  labels:
                    app: {{ genericPitcherName | default('homerun-generic-pitcher') }}
                  dataType: stringData
                  secretKVs:
                    WEBHOOK_TOKEN: {{ genericPitcherToken }}

                redis-connection-homerun-generic-pitcher:
                  name: redis-connection-{{ genericPitcherName | default('homerun-generic-pitcher') }}
                  labels:
                    app: {{ genericPitcherName | default('homerun-generic-pitcher') }}
                  dataType: stringData
                  secretKVs:
                    REDIS_SERVER: {{ redisStackServiceName | default('redis-stack-headless') }}.{{ deployment_namespace }}.svc.cluster.local
                    REDIS_PORT: {{ redisStackPort | default('6379') }}
                    REDIS_PASSWORD: {{ redisStackPassword }}

              customresources:
                homerun-generic-pitcher-certificate:
                  apiVersion: cert-manager.io/v1
                  kind: Certificate
                  metadata:
                    name: {{ genericPitcherName | default('homerun-generic-pitcher') }}-ingress
                    labels:
                      app: {{ genericPitcherName | default('homerun-generic-pitcher') }}
                  spec:
                    commonName: {{ genericPitcherHostname | default('homerun') }}.{{ genericPitcherDomain | default('example.com') }}
                    dnsNames:
                      - {{ genericPitcherHostname | default('homerun') }}.{{ genericPitcherDomain | default('example.com') }}
                    issuerRef:
                      name: {{ genericPitcherIssuerName | default('selfsigned') }}
                      kind: {{ genericPitcherIssuerKind | default('ClusterIssuer') }}
                    secretName: {{ genericPitcherName | default('homerun-generic-pitcher') }}-ingress-tls

              ingress:
                homerun-generic-pitcher-ingress:
                  labels:
                    app: {{ genericPitcherName | default('homerun-generic-pitcher') }}
                  name: {{ genericPitcherName | default('homerun-generic-pitcher') }}
                  ingressClassName: {{ genericPitcherIngressClass | default('nginx') }}
                  annotations:
                    nginx.ingress.kubernetes.io/ssl-redirect: "true"
                  service:
                    name: {{ genericPitcherName | default('homerun-generic-pitcher') }}-service
                    port: {{ genericPitcherIngressPort | default('80') }}
                    path: /{{ genericPitcherApiPath | default('generic') }}
                    pathType: Prefix
                  hostname: {{ genericPitcherHostname | default('homerun') }}
                  domain: {{ genericPitcherDomain | default('example.com') }}
                  tls:
                    secretName: {{ genericPitcherName | default('homerun-generic-pitcher') }}-ingress-tls
                    host: {{ genericPitcherHostname | default('homerun') }}.{{ genericPitcherDomain | default('example.com') }}

        text-catcher:
          ref: "oci://ghcr.io/stuttgart-things/homerun"
          version: "{{ homerun_chart_version | default('v0.2.1') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            text-catcher:
              enabled: {{ textCatcherEnabled }}
              configmaps:
                homerun-text-catcher:
                  REDIS_STREAM: "{{ stream | default('homerun') }}"
                  LOGGING: {{ textCatcherLogging | default('terminal') }}
              secrets:
                redis-connection-homerun-text-catcher:
                  name: redis-connection-{{ textCatcherName | default('homerun-text-catcher') }}
                  labels:
                    app: {{ textCatcherName | default('homerun-text-catcher') }}
                  dataType: stringData
                  secretKVs:
                    REDIS_SERVER: {{ redisStackServiceName | default('redis-stack-headless') }}.{{ deployment_namespace }}.svc.cluster.local
                    REDIS_PORT: {{ redisStackPort | default('6379') }}
                    REDIS_PASSWORD: {{ redisStackPassword }}

      post_manifests: {}
