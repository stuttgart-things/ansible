---
vars:
  - name: cert-manager
    file: |
      ---
      deployment_namespace: cert-manager
      helm_repositories:
        cert-manager:
          url: https://charts.jetstack.io

      helm_releases:
        cert-manager:
          ref: cert-manager/cert-manager
          version: v1.17.1
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            installCRDs: true

      post_manifests: {}

  - name: ingress-nginx
    file: |
      ---
      ingress_nginx_version: 4.10.1
      deployment_namespace: ingress-nginx
      helm_repositories:
        ingress-nginx:
          url: https://kubernetes.github.io/ingress-nginx

      post_manifests: {}

      helm_releases:
        ingress-nginx:
          ref: ingress-nginx/ingress-nginx
          version: "{{ ingress_nginx_version }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: {}

  - name: rancher
    file: |
      ---
      rancher_version: 2.8.5
      deployment_namespace: cattle-system
      helm_repositories:
        rancher-stable:
          url: https://releases.rancher.com/server-charts/latest

      helm_releases:
        rancher:
          ref: rancher-stable/rancher
          version: "{{ rancher_version }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            global:
              cattle:
                psp:
                  enabled: false
            bootstrapPassword: {{ password }}
            hostname: {{ hostname }}.{{ domain }}
            privateCA: true
            ingress:
              enabled: true
              ingressClassName: nginx
              servicePort: 80
              tls:
                source: secret
                secretName: {{ hostname }}-tls

  - name: headlamp
    file: |
      ---
      headlamp_version: 0.33.0
      deployment_namespace: kube-system
      hostname: headlamp
      domain: example.com
      issuer_name: selfsigned
      create_cert_resource: false

      helm_repositories:
        headlamp:
          url: https://kubernetes-sigs.github.io/headlamp/

      helm_releases:
        headlamp:
          ref: headlamp/headlamp
          version: "{{ headlamp_version | default('0.33.0') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            ingress:
              enabled: {{ ingress_enabled | default(true) }}
              ingressClassName: {{ ingress_class_name | default('nginx') }}
            {% if not create_cert_resource %}
              annotations:
                cert-manager.io/{{ issuer_annotation | default('cluster-issuer') }}: "{{ issuer_name }}"
            {% endif %}
              hosts:
                - host: {{ hostname }}.{{ domain }}
                  paths:
                    - path: /
                      type: ImplementationSpecific
              tls:
                - secretName: {{ hostname }}-ingress-tls
                  hosts:
                    - {{ hostname }}.{{ domain }}

        headlamp-app-configuration:
          ref: oci://ghcr.io/stuttgart-things/sthings-cluster
          version: "{{ sthings_cluster_chart_version | default('0.3.15') }}"
          namespace: "{{ deployment_namespace }}"
          ignore: false
          wait: true
          release_values: |
            ---
            serviceAccounts:
              headlamp-admin:
                namespace: {{ deployment_namespace }}

            clusterRoleBindings:
              headlamp-cluster-admin:
                roleRef:
                  kind: ClusterRole
                  name: cluster-admin
                  apiGroup: rbac.authorization.k8s.io
                subjects:
                  - kind: ServiceAccount
                    name: headlamp-admin
                    namespace: {{ deployment_namespace }}

            {% if create_cert_resource %}
            customresources:
              ingress-certificate-headlamp:
                apiVersion: cert-manager.io/v1
                kind: Certificate
                metadata:
                  name: headlamp-ingress
                  namespace: {{ deployment_namespace }}
                spec:
                  commonName: {{ hostname }}.{{ domain }}
                  dnsNames:
                    - {{ hostname }}.{{ domain }}
                  issuerRef:
                    name: {{ issuer_name }}
                    kind: {{ issuer_annotation | default('cluster-issuer') }}
                  secretName: {{ hostname }}-ingress-tls
            {% endif %}

      post_manifests: {}
