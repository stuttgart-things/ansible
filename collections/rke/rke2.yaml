---
playbooks:
  - name: upload_kubeconfig_vault
    play: |
      - hosts: localhost
        tasks:
          - name: Include vars
            ansible.builtin.include_vars: "{{ path_to_vars_file }}.yaml"
            when: path_to_vars_file is defined

          - ansible.builtin.add_host:
              name: "{{ groups['initial_master_node'][0] }}"
              groups: initial_master_node

      - hosts: initial_master_node
        vars:
          vault_approle_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
          vault_approle_secret: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
          vault_url: "{{ lookup('env', 'VAULT_ADDR') }}"
          replace_ip: true
          check_kubeconfig: true
          create_flux_ns: false

          kubeconfig_path: /etc/rancher/rke2/rke2.yaml
          secret_path_kubeconfig: kubeconfigs
          cluster_name: test-cluster

        pre_tasks:
          - name: Include vars
            ansible.builtin.include_vars: "{{ path_to_vars_file }}.yaml"
            when: path_to_vars_file is defined

        tasks:
          - name: Fetch kubeconfig local to ansible host
            ansible.builtin.fetch:
              src: "{{ kubeconfig_path }}"
              dest: "{{ kubeconfig_path|basename }}"
              flat: yes
              run_once: true
            become: true

          - name: Create flux-system namespace
            kubernetes.core.k8s:
              name: flux-system
              api_version: v1
              kind: Namespace
              state: present
              kubeconfig: "{{ kubeconfig_path|basename }}"
            when: create_flux_ns|bool
            delegate_to: localhost

          - name: Add external ip to kubeconfig
            ansible.builtin.replace:
              dest: "{{ kubeconfig_path|basename }}"
              regexp: '127.0.0.1'
              replace: "{{ ansible_default_ipv4.address }}"
            delegate_to: localhost
            when: replace_ip|bool

          - name: Write kubeconfig to vault using key value V2 engine
            community.hashi_vault.vault_write:
              auth_method: approle
              url: "{{ vault_url }}"
              role_id: "{{ vault_approle_id }}"
              secret_id: "{{ vault_approle_secret }}"
              validate_certs: false
              path: "{{ secret_path_kubeconfig }}/data/{{ cluster_name }}"
              data:
                data:
                  kubeconfig: "{{ lookup('ansible.builtin.file', kubeconfig_path|basename)|b64encode }}"
            delegate_to: localhost

  - name: rke2_workflow
    play: |
      - hosts: all
        gather_facts: true
        become: true

        pre_tasks:
          - name: Include vars
            ansible.builtin.include_vars: "{{ path_to_vars_file }}.yaml"

        roles:
          - role: sthings.rke.deploy_configure_rke

  - name: rke2
    play: |
      - hosts: all
        gather_facts: true
        become: true

        vars:
          rke_state: present #absent
          rke_version: 2
          rke2_k8s_version: 1.33.4
          rke2_airgapped_installation: true
          rke2_release_kind: rke2r1 #rke2r2
          prepare_rancher_ha_nodes: true #false
          cluster_setup: multinode
          disableKubeProxy: true
          disable_rke2_components:
            - rke2-ingress-nginx
            - rke2-snapshot-controller
            - rke2-snapshot-controller-crd
            - rke2-snapshot-validation-webhook
          rke2_cni: none
          install_cilium: true
          cluster_name: rke2
          fetched_kubeconfig_path: "{{ cluster_name | default('kubeconfig') }}.yaml"
          rke2_registry_mirrors:
            - name: "docker.io"
              endpoints:
                - "{{ registry_mirror_url | default('https://registry-1.docker.io') }}"

          manifests:
            lb_pool:
              manifest: |
                apiVersion: cilium.io/v2alpha1
                kind: CiliumLoadBalancerIPPool
                metadata:
                  name: first-pool
                spec:
                  blocks:
                    - start: {{ cilium_lbrange_start_ip | default('192.168.5.10') }}
                      stop: {{ cilium_lbrange_stop_ip | default('192.168.5.20') }}

            announcement_policy:
              manifest: |
                ---
                apiVersion: cilium.io/v2alpha1
                kind: CiliumL2AnnouncementPolicy
                metadata:
                  name: default-l2-announcement-policy
                  namespace: kube-system
                spec:
                  externalIPs: true
                  loadBalancerIPs: true

        roles:
          - role: sthings.rke.deploy_configure_rke

  - name: api_token
    play: |
      ---
      - hosts: "{{ target_host | default('localhost') }}"
        vars:
          token_name: admin
          token_description: admin token
          token_ttl: 0
          state: present
          output_token_creds: true

          manifests:
            token: |
              {
                "apiVersion": "management.cattle.io/v3",
                "authProvider": "local",
                "current": false,
                "description": "{{ token_description }}",
                "expired": false,
                "expiresAt": "",
                "isDerived": true,
                "kind": "Token",
                "metadata": {
                  "labels": {
                    "authn.management.cattle.io/token-userId": "{{ token_user_id }}",
                    "cattle.io/creator": "kubectl"
                  },
                  "name": "{{ token_name }}"
                },
                "token": "{{ token_password }}",
                "ttl": {{ token_ttl }},
                "userId": "{{ token_user_id }}"
              }

        pre_tasks:
          - name: set user password
            ansible.builtin.set_fact:
              token_password: "{{ lookup('community.general.random_string', length=16, special=false) }}"
            when: token_password is not defined

          - name: Get admin user id
            block:
              - name: Get admin user
                kubernetes.core.k8s_info:
                  api_version: management.cattle.io/v3
                  kind: users
                  namespace: cattle-system
                  kubeconfig: "{{ path_to_kubeconfig }}"
                  label_selectors:
                    - authz.management.cattle.io/bootstrapping = admin-user
                register: admin_user

              - name: output
                ansible.builtin.debug:
                  var: admin_user.resources[0].metadata.name

              - name: set userid
                ansible.builtin.set_fact:
                  token_user_id: "{{ admin_user.resources[0].metadata.name }}"
            when: token_user_id is not defined

        tasks:
          - name: Create api token
            ansible.builtin.include_tasks: manifests.yaml
            loop: "{{ q('ansible.builtin.dict', manifests) }}"
            when: manifests is defined

        post_tasks:
          - name: Output credentials
            ansible.builtin.debug:
              var: token_password

          - name: Output credentials
            ansible.builtin.debug:
              msg: "token {{ token_name }} created w/ password {{ token_password }}. Bearer is {{ token_name }}:{{ token_password }}"
